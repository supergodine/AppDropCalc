<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug Login</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        form { margin: 20px 0; padding: 20px; border: 1px solid #ccc; }
        input { margin: 5px; padding: 8px; width: 200px; }
        button { padding: 10px 20px; background: #007bff; color: white; border: none; cursor: pointer; }
        #logs { background: #f8f9fa; padding: 15px; margin: 20px 0; height: 400px; overflow-y: scroll; border: 1px solid #ddd; white-space: pre-wrap; font-family: monospace; }
    </style>
</head>
<body>
    <h1>ğŸ” Debug Login DropCalc</h1>
    
    <div>
        <h2>ğŸ“ Teste de Cadastro</h2>
        <form id="registerForm">
            <div>
                <input type="text" id="regName" placeholder="Nome" value="Usuario Teste">
                <input type="email" id="regEmail" placeholder="Email" value="teste@exemplo.com">
                <input type="password" id="regPassword" placeholder="Senha" value="123456">
                <button type="submit">Cadastrar</button>
            </div>
        </form>
    </div>

    <div>
        <h2>ğŸ” Teste de Login</h2>
        <form id="loginForm">
            <div>
                <input type="email" id="loginEmail" placeholder="Email" value="teste@exemplo.com">
                <input type="password" id="loginPassword" placeholder="Senha" value="123456">
                <button type="submit">Login</button>
            </div>
        </form>
    </div>

    <div>
        <h2>ğŸ“Š Status da AutenticaÃ§Ã£o</h2>
        <button id="checkAuth">Verificar Auth</button>
        <button id="clearAuth">Limpar Auth</button>
        <div id="authStatus" style="margin: 10px 0; padding: 10px; background: #f0f0f0;"></div>
    </div>

    <div>
        <h2>ğŸ“‹ Logs</h2>
        <button id="clearLogs">Limpar Logs</button>
        <div id="logs"></div>
    </div>

    <script>
        const API_BASE = 'https://appdropcalc-production.up.railway.app';
        const logs = document.getElementById('logs');

        function log(message) {
            console.log(message);
            const timestamp = new Date().toLocaleTimeString();
            logs.innerHTML += `[${timestamp}] ${message}\n`;
            logs.scrollTop = logs.scrollHeight;
        }

        // Teste de cadastro
        document.getElementById('registerForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const name = document.getElementById('regName').value;
            const email = document.getElementById('regEmail').value;
            const password = document.getElementById('regPassword').value;

            log(`ğŸ”„ Tentando cadastrar: ${email}`);

            try {
                const response = await fetch(`${API_BASE}/auth/signup`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ name, email, password }),
                });

                log(`ğŸ“¡ Response status: ${response.status}`);
                log(`ğŸ“¡ Response ok: ${response.ok}`);

                const responseText = await response.text();
                log(`ğŸ“¡ Response body: ${responseText}`);

                if (!response.ok) {
                    try {
                        const error = JSON.parse(responseText);
                        log(`âŒ Erro no cadastro: ${JSON.stringify(error)}`);
                    } catch (e) {
                        log(`âŒ Erro no cadastro (nÃ£o Ã© JSON): ${responseText}`);
                    }
                    return;
                }

                const data = JSON.parse(responseText);
                log(`âœ… Cadastro bem-sucedido!`);
                log(`ğŸ“„ Dados recebidos: ${JSON.stringify(data, null, 2)}`);

                // Salvar dados
                if (data.accessToken) {
                    localStorage.setItem('accessToken', data.accessToken);
                    log(`ğŸ’¾ Token salvo: ${data.accessToken.substring(0, 30)}...`);
                }
                if (data.user) {
                    localStorage.setItem('currentUser', JSON.stringify(data.user));
                    log(`ğŸ‘¤ UsuÃ¡rio salvo: ${data.user.email}`);
                }

            } catch (error) {
                log(`ğŸ’¥ Erro na requisiÃ§Ã£o: ${error.message}`);
                log(`ğŸ’¥ Stack: ${error.stack}`);
            }
        });

        // Teste de login
        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;

            log(`ğŸ”„ Tentando login: ${email}`);

            try {
                const response = await fetch(`${API_BASE}/auth/login`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ email, password }),
                });

                log(`ğŸ“¡ Response status: ${response.status}`);
                log(`ğŸ“¡ Response ok: ${response.ok}`);

                const responseText = await response.text();
                log(`ğŸ“¡ Response body: ${responseText}`);

                if (!response.ok) {
                    try {
                        const error = JSON.parse(responseText);
                        log(`âŒ Erro no login: ${JSON.stringify(error)}`);
                    } catch (e) {
                        log(`âŒ Erro no login (nÃ£o Ã© JSON): ${responseText}`);
                    }
                    return;
                }

                const data = JSON.parse(responseText);
                log(`âœ… Login bem-sucedido!`);
                log(`ğŸ“„ Dados recebidos: ${JSON.stringify(data, null, 2)}`);

                // Salvar dados
                if (data.accessToken) {
                    localStorage.setItem('accessToken', data.accessToken);
                    log(`ğŸ’¾ Token salvo: ${data.accessToken.substring(0, 30)}...`);
                }
                if (data.user) {
                    localStorage.setItem('currentUser', JSON.stringify(data.user));
                    log(`ğŸ‘¤ UsuÃ¡rio salvo: ${data.user.email}`);
                }

            } catch (error) {
                log(`ğŸ’¥ Erro na requisiÃ§Ã£o: ${error.message}`);
                log(`ğŸ’¥ Stack: ${error.stack}`);
            }
        });

        // Verificar autenticaÃ§Ã£o
        document.getElementById('checkAuth').addEventListener('click', () => {
            const token = localStorage.getItem('accessToken');
            const user = localStorage.getItem('currentUser');
            const plan = localStorage.getItem('userPlan');

            log(`ğŸ” Status da autenticaÃ§Ã£o:`);
            log(`  Token: ${token ? 'Existe (' + token.substring(0, 30) + '...)' : 'NÃ£o existe'}`);
            log(`  User: ${user || 'NÃ£o existe'}`);
            log(`  Plan: ${plan || 'NÃ£o existe'}`);

            const authStatus = document.getElementById('authStatus');
            authStatus.innerHTML = `
                <p><strong>ğŸ« Token:</strong> ${token ? 'Sim (' + token.substring(0, 30) + '...)' : 'NÃ£o'}</p>
                <p><strong>ğŸ‘¤ UsuÃ¡rio:</strong> ${user ? JSON.parse(user).email : 'NÃ£o logado'}</p>
                <p><strong>ğŸ“‹ Plano:</strong> ${plan ? JSON.parse(plan).name : 'NÃ£o selecionado'}</p>
                <p><strong>ğŸ” Autenticado:</strong> ${token && user ? 'SIM' : 'NÃƒO'}</p>
            `;
        });

        // Limpar autenticaÃ§Ã£o
        document.getElementById('clearAuth').addEventListener('click', () => {
            localStorage.removeItem('accessToken');
            localStorage.removeItem('currentUser');
            localStorage.removeItem('userPlan');
            localStorage.removeItem('billingStatus');
            localStorage.removeItem('subscriptionPeriod');
            localStorage.removeItem('subscriptionDate');
            localStorage.removeItem('premiumActive');
            log(`ğŸ§¹ Dados de autenticaÃ§Ã£o limpos`);
            document.getElementById('checkAuth').click();
        });

        // Limpar logs
        document.getElementById('clearLogs').addEventListener('click', () => {
            logs.innerHTML = '';
            log('ğŸ§¹ Logs limpos');
        });

        // Log inicial
        log('ğŸš€ Sistema de debug carregado');
        log(`ğŸŒ API Base URL: ${API_BASE}`);
        log('ğŸ“‹ Comandos disponÃ­veis:');
        log('  1. Cadastrar um novo usuÃ¡rio');
        log('  2. Fazer login com usuÃ¡rio existente');
        log('  3. Verificar status da autenticaÃ§Ã£o');
        log('  4. Limpar dados de autenticaÃ§Ã£o');
        log('');
        
        // Verificar estado inicial
        document.getElementById('checkAuth').click();
    </script>
</body>
</html>