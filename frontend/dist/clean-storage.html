<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üßπ Limpeza do LocalStorage</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            margin: 20px; 
            background: #f5f5f5;
        }
        .section { 
            background: white; 
            padding: 20px; 
            margin: 10px 0; 
            border-radius: 8px; 
            border-left: 4px solid #007acc;
        }
        .error { border-left-color: #dc3545; }
        .success { border-left-color: #28a745; }
        .warning { border-left-color: #ffc107; }
        pre { 
            background: #f8f9fa; 
            padding: 10px; 
            border-radius: 4px; 
            overflow-x: auto;
            max-height: 200px;
            overflow-y: auto;
        }
        button {
            background: #007acc;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover { background: #005999; }
        .clean-btn { background: #dc3545; }
        .clean-btn:hover { background: #c82333; }
    </style>
</head>
<body>
    <h1>üßπ Limpeza do LocalStorage - DropCalc</h1>
    
    <div class="section">
        <h2>üìä Estado Atual do LocalStorage</h2>
        <pre id="current-state"></pre>
        <button onclick="refreshState()">üîÑ Atualizar</button>
    </div>
    
    <div class="section warning">
        <h2>‚ö†Ô∏è Itens Problem√°ticos Detectados</h2>
        <pre id="problematic-items"></pre>
    </div>
    
    <div class="section">
        <h2>üõ†Ô∏è A√ß√µes de Limpeza</h2>
        <button onclick="cleanProblematicItems()">üßπ Limpar Itens Problem√°ticos</button>
        <button onclick="cleanAllAuthData()" class="clean-btn">üóëÔ∏è Limpar Todos os Dados de Auth</button>
        <button onclick="cleanEverything()" class="clean-btn">üí• Limpar Tudo</button>
    </div>
    
    <div class="section">
        <h2>üìù Log de A√ß√µes</h2>
        <pre id="action-log"></pre>
    </div>

    <script>
        function log(message) {
            const logEl = document.getElementById('action-log');
            const timestamp = new Date().toLocaleTimeString();
            logEl.textContent += `[${timestamp}] ${message}\n`;
            logEl.scrollTop = logEl.scrollHeight;
        }

        function refreshState() {
            const currentState = document.getElementById('current-state');
            const problematicItems = document.getElementById('problematic-items');
            
            let allItems = '';
            let problematic = '';
            
            // Listar todos os itens do localStorage
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                const value = localStorage.getItem(key);
                
                allItems += `${key}: ${value}\n`;
                
                // Verificar se √© problem√°tico
                if (key.includes('user') || key.includes('plan') || key.includes('premium')) {
                    try {
                        if (value && (value.startsWith('{') || value.startsWith('['))) {
                            JSON.parse(value);
                        }
                    } catch (error) {
                        problematic += `‚ùå ${key}: "${value}" (ERRO: ${error.message})\n`;
                    }
                    
                    // Verificar valores simples que deveriam ser objetos
                    if (key === 'userPlan' && value && !value.startsWith('{')) {
                        problematic += `‚ùå ${key}: "${value}" (DEVERIA SER OBJETO JSON)\n`;
                    }
                    if (key === 'currentUser' && value && !value.startsWith('{')) {
                        problematic += `‚ùå ${key}: "${value}" (DEVERIA SER OBJETO JSON)\n`;
                    }
                }
            }
            
            currentState.textContent = allItems || 'LocalStorage vazio';
            problematicItems.textContent = problematic || '‚úÖ Nenhum item problem√°tico encontrado';
            
            log('Estado do localStorage atualizado');
        }

        function cleanProblematicItems() {
            const itemsToCheck = ['userPlan', 'currentUser', 'premiumActive', 'billingStatus'];
            let cleaned = 0;
            
            itemsToCheck.forEach(key => {
                const value = localStorage.getItem(key);
                if (value) {
                    try {
                        if (key === 'userPlan' || key === 'currentUser') {
                            if (!value.startsWith('{')) {
                                localStorage.removeItem(key);
                                log(`üßπ Removido ${key}: "${value}" (n√£o era JSON)`);
                                cleaned++;
                            } else {
                                JSON.parse(value); // Testar se √© JSON v√°lido
                            }
                        }
                    } catch (error) {
                        localStorage.removeItem(key);
                        log(`üßπ Removido ${key}: "${value}" (JSON inv√°lido)`);
                        cleaned++;
                    }
                }
            });
            
            if (cleaned === 0) {
                log('‚úÖ Nenhum item problem√°tico encontrado');
            } else {
                log(`‚úÖ ${cleaned} itens problem√°ticos removidos`);
            }
            
            refreshState();
        }

        function cleanAllAuthData() {
            const authKeys = [
                'accessToken', 'currentUser', 'userPlan', 'premiumActive',
                'billingStatus', 'subscriptionPeriod', 'subscriptionDate',
                'token', 'refreshToken'
            ];
            
            let removed = 0;
            authKeys.forEach(key => {
                if (localStorage.getItem(key)) {
                    localStorage.removeItem(key);
                    removed++;
                }
            });
            
            log(`üóëÔ∏è ${removed} dados de autentica√ß√£o removidos`);
            refreshState();
        }

        function cleanEverything() {
            const count = localStorage.length;
            localStorage.clear();
            log(`üí• ${count} itens removidos - localStorage limpo completamente`);
            refreshState();
        }

        // Executar ao carregar
        refreshState();
        log('üöÄ Ferramenta de limpeza carregada');
    </script>
</body>
</html>